<!DOCTYPE html>
<html>
<head>
    <title>抽奖</title>
    <meta charset="UTF-8">
    <meta content="width=device-width,user-scalable=no" name="viewport">
    <meta name="apple-itunes-app" content="app-id=425349261">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="stylesheet" type="text/css" href="reset.css">
    <style>
        body {
            margin: auto;
            max-width: 500px;
        }

        #app {
            position: relative;
            overflow: hidden;
            display: block;

            width: 100%;
            height: 100%;
        }

        .main {
            z-index: 5;
            position: relative;
            text-align: center;
            color: #fff;
        }

        main {
            float: left;
            position: absolute;

            background-image: url('img/xbeat.gif');
            background-repeat: no-repeat;
            background-size: 100%;
            -moz-background-size: 100%;
            background-position: center;
            background-color: #0b111c;
        }

        main div{
            margin: 20px;
            line-height: 30px;
            font-size: 1.4rem;
        }

        header {
            float: left;
            position: absolute;

            margin: 0;
            font-size: 2.4rem;
            font-family: "Lato", "Helvetica Neue", Helvetica, Arial, sans-serif;
            color: #fff8f8;

            background-image: url('img/wait.gif');
            background-repeat: no-repeat;
            background-size: 100%;
            -moz-background-size: 100%;
            background-position: center;
            background-color: #00c3ff;
        }

        header h1 {
            display: block;
            padding: 80px 0 0;
        }

        header .input {
            margin: 30px auto;
            border: 1px solid #fff;
            border-radius: 10px;
            width: 200px;
            height: 40px;
            padding: 0;
        }

        header input {
            vertical-align: text-top;
            width: 200px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            color: #fff;
            font-size: 2rem;
            z-index: 1;
        }

        .btn {
            width: 200px;
            height: 40px;
            line-height: 40px;
            border-radius: 10px;
            color: #fff;
            background-color: #009cfe;
        }

        header .btn {
            position: absolute;
            bottom: 20%;
            left:50%;
            z-index: 100;
            -webkit-transform: translateX(-50%);
            -moz-transform: translateX(-50%);
            -ms-transform: translateX(-50%);
            -o-transform: translateX(-50%);
            transform: translateX(-50%);
        }

        .btnfirst{
            position: absolute;
            bottom: 10%;
            left:50%;
            z-index: 100;
            -webkit-transform: translateX(-50%);
            -moz-transform: translateX(-50%);
            -ms-transform: translateX(-50%);
            -o-transform: translateX(-50%);
            transform: translateX(-50%);
        }

        header input{
            color: #000;
        }

        .bk3class{
            position: absolute;
            background-image: url('img/xbeat.gif');
            background-repeat: no-repeat;
            background-size: 100%;
            -moz-background-size: 100%;
            background-position: center;
            background-color: #0b111c;
            font-size: 2rem;
        }

        .bk3class input{
            font-size: 1.8rem;
            color: #ffffff;
        }

        .bk3class .input{
            position: absolute;
            bottom: 5%;
            left:50%;
            z-index: 100;
            -webkit-transform: translateX(-50%);
            -moz-transform: translateX(-50%);
            -ms-transform: translateX(-50%);
            -o-transform: translateX(-50%);
            transform: translateX(-50%);
        }

        .bk3class .input1{
            position: absolute;
            bottom: 20%;
            left:50%;
            z-index: 100;
            -webkit-transform: translateX(-50%);
            -moz-transform: translateX(-50%);
            -ms-transform: translateX(-50%);
            -o-transform: translateX(-50%);
            transform: translateX(-50%);
        }

        .bk4{
            position: absolute;
            background-image: url('img/last.jpg');
            background-repeat: no-repeat;
            background-size: 100%;
            -moz-background-size: 100%;
            background-position: center;
            background-color: #ffffff;

            color: #000000;
        }
        .bk4 li{
            line-height: 30px;
            font-size: 2rem;
        }

        :-moz-placeholder { /* Mozilla Firefox 4 to 18 */
            color: #000; opacity:1;
        }

        ::-moz-placeholder { /* Mozilla Firefox 19+ */
            color: #000;opacity:1;
        }

        input:-ms-input-placeholder{
            color: #000;opacity:1;
        }

        input::-webkit-input-placeholder{
            color: #000;opacity:1;
        }

    </style>
    <link href="https://cdn.jsdelivr.net/npm/animate.css@3.5.1" rel="stylesheet" type="text/css">
    <script src="https://unpkg.com/vue"></script>

</head>
<body>
<div id="app">
    <div class="main">
        <transition
                name="custom-classes-transition"
                enter-active-class="animated slideInLeft"
                leave-active-class="animated fadeOut">
            <header v-show="readlypaly" :style="full">
                <div class="clear"></div>
                <h1 v-text="peoplenub"></h1>
                <div class="clear"></div>
                <div class="input" v-show="firstbtn">
                    <input  type="number" placeholder="输入玩家人数" v-model="toPostPeopleNub">
                </div>
                <div class="input">
                    <input placeholder="输入玩家姓名" v-model="name">
                </div>
                <div class="clear"></div>
                <div class="btn" @click="peopleNumFuc" v-show="firstbtn">提交</div>

                <div class="btn btnfirst" @click="perNumFuc" v-show="secbtn">准备</div>
                <!--<div class="waitwrap" v-show="bk1" :style="full">-->
                <!--<img src="img/wait.gif">-->
                <!--</div>-->
            </header>
        </transition>
        <div class="clear"></div>
        <transition
                name="custom-classes-transition"
                enter-active-class="animated fadeIn"
                leave-active-class="animated fadeOut">
            <main :style="full" v-show="bk2">
                <div v-text="allPeopleNum"></div>

                <div>等待所有人准备好</div>
            </main>
        </transition>

        <transition
                name="custom-classes-transition"
                enter-active-class="animated slideInLeft"
                leave-active-class="animated fadeOut">
            <div v-show="bk3" class="bk3class" :style="full">
                <div style="margin: 40px">返回范围</div>
                <div style="margin: 40px" v-text="resNub"></div>
                <div class="input" style="border: 1px solid #ffffff;width: 200px;height: 40px;line-height: 40px;border-radius: 10px">
                    <input v-model = "toPostResData" type="number">
                </div>
                <div @click="toPostRes" class="input1">提交</div>
            </div>
        </transition>


        <!--排名-->
        <transition
                name="custom-classes-transition"
                enter-active-class="animated slideInLeft"
                leave-active-class="animated fadeOut">
            <div v-show="bk4" class="bk4" :style="full">
                <ul>
                    <li v-for="item in namelist">{{ item }}</li>
                </ul>
            </div>
        </transition>
    </div>

</div>
</body>
<script type="text/javascript">
    const debugflag = true;
    const ws = new WebSocket("ws://localhost:8080");

    const windowWidth = document.body.clientWidth + "px";
    const windowHeight = document.body.clientHeight + "px";

    function todebug(data) {
        if (debugflag) {
            console.log(data)
        }
    }

    var app = new Vue({
        el: '#app',
        data: {
            peoplenub: "当前在线人数",
            toPostPeopleNub: '',
            readlypaly: true,
            bk1: true,
            bk2: false,
            bk3: false,
            bk4: false,
            firstbtn: true,
            secbtn: false,
            full: "width:" + windowWidth + ";height:" + windowHeight,
            flag: true,
            allPeopleNum: '',
            tostartFlagNub: 'b',
            tostartFlagAll: 'a',
            tostartFlag: false,
            toPostResData: '',
            resNub: '',
            firstNub: 0,
            lastNub: 1000,
            showresTest: '',
            name: '',
            namelist: [],
            zhunbeiflag: true,
            toPostPeopleNubflag: ''
        },
        methods: {
            peopleNumFuc: function () {
                let _this = this;
                todebug('提交人数');

                let testinput = /^\d+$/.test(_this.toPostPeopleNub)
                if(!testinput){
                    alert('请输入正确的数字');
                    return
                }

                if(!_this.name){
                    alert('请输入昵称');
                    return
                }
                let data = {playNub: _this.toPostPeopleNub, type: 1,}
                ws.send(JSON.stringify(data));
//                todebug(data);
                _this.readlypaly = false;
                _this.bk1 = false;
                _this.bk2 = true;
            },
            perNumFuc: function () {
                let _this = this;
                todebug('准备人数');

                if(!_this.name){
                    alert('请输入昵称！');
                    return
                }

                if(!!_this.toPostPeopleNubflag){
                    let data = {playNub: _this.toPostPeopleNub, type: 2, parperPeople: true};
                    ws.send(JSON.stringify(data));
                    _this.zhunbeiflag = false;
                    _this.readlypaly = false;
                    _this.bk1 = false;
                    _this.bk2 = true;
                }else{
                    alert('请等待第一用户设置人数')
                    return;
                }

            },

            toPostRes: function () {
                let data = { type: 4,message: this.toPostResData};
                ws.send(JSON.stringify(data));
            }
        },
        mounted: function () {
            const _this = this;
        }
    })

    todebug(app.peoplenub);

    ws.onopen = function () {
        todebug(ws);
    };
    ws.onmessage = function (evt) {
        todebug(evt.data)
        let resdata = JSON.parse(evt.data);
        let type = resdata.type;
        let b = resdata.parperPeople;
        switch (type) {
            case 1://接受在线人数
                todebug(resdata.peopleAllNub);

                if(!!resdata.peopleAllNub){
                    app.toPostPeopleNubflag = resdata.peopleAllNub
                }

                app.peoplenub = "当前有" + resdata.peoplenub + "人在线";
                app.allPeopleNum = "准备等待中" + b + "/" + resdata.peopleAllNub;
                app.tostartFlagNub = b;
                app.tostartFlagAll = resdata.peopleAllNub;
                todebug(app.flag);

                if (app.flag == true) {
                    if (resdata.peoplenub == 1) {
                        app.firstbtn = true;
                        app.secbtn = false;
                        app.flag = false;
                    } else {
                        app.firstbtn = false;
                        app.secbtn = true;
                        app.flag = false;
                    }
                }else{
                    if (resdata.peoplenub == 1) {
                        app.firstbtn = true;
                        app.secbtn = false;
                        app.flag = false;
                    }
                }
                break;
            case 2:
                todebug(b);
                app.allPeopleNum = "准备等待中" + b + "/" + resdata.peopleAllNub;
                break;
            case 3:
                todebug(resdata);

//                所填写的数字
                if(resdata.message == 'success'){
                    todebug('succsee');
                    let lastres = {type: 5,name: app.name};
                    ws.send(JSON.stringify(lastres));

                    let data = { type: 4,message: app.toPostResData};
                    let timefuc = setTimeout(function () {
                        ws.send(JSON.stringify(data));
                        clearTimeout(timefuc)
                    },1000);
                }else{
                    if(resdata.message == 'bigger'){
                        todebug('bigger');
                        app.lastNub = app.toPostResData;
                        app.resNub = "范围在"+app.firstNub+"~"+app.lastNub;
                    }else{
                        todebug('s');
                        app.firstNub = app.toPostResData;
                        app.resNub = "范围在"+app.firstNub+"~"+app.lastNub;
                    }
                    app.toPostResData = '';
                }

                break;
            case 4:
                todebug(resdata);
                app.namelist.splice(0,app.namelist.length)
                app.namelist = resdata.people;
                app.bk3 = false;
                app.bk4 = true;
                break;
            default:
                todebug('nothing');
                break;
        }
    };

    ws.onclose = function (evt) {
        todebug("WebSocketClosed!");
        todebug(evt);
        ws.send({people: false});
    };

    ws.onerror = function (evt) {
        todebug("WebSocketError!");
    };

    function send() {
        var str = "{name:'" + name + "',msg:'" + msg + "',key:'" + key + "'}";
        todebug("发送", str);
        ws.send(str);
    };

    function exit() {
        if(!app.zhunbeiflag){
            let data = {playNub: app.toPostPeopleNub, type: 2, parperPeople: false};
            ws.send(JSON.stringify(data));
        }

        var r = ws.close();
        todebug("退出", r);
    }
    window.onbeforeunload = function () {
        exit()
    }

    app.$watch('tostartFlagNub', function () {
        // 做点什么
        if(this.tostartFlagNub == this.tostartFlagAll || this.tostartFlagAll ==1){
            let data = {type: 3,flag: 'start'};
            ws.send(JSON.stringify(data));

            this.tostartFlag = true;
            this.bk2 = false;

            if(!!this.name){
                this.bk3 = true;
            }
        }
//        if(this.tostartFlagNub > this.tostartFlagAll){
//            alert('当前人数过多，请等待')
////            this.bk2 = false;
////
////            if(!!this.name){
////                this.bk3 = true;
////            };
//            return ;
//        }
//        else{
//            this.tostartFlag = false;
//        }
    })

    app.$watch('bk3', function () {
        // 做点什么
        this.secbtn = false;
    })
</script>

</html>